
\chapter{引言}
\label{chap:Introduction}

\section{课题研究的背景和意义}
\label{section:background}
%加速器是什么？
粒子加速器（particle accelerator）是使带电粒子在高真空场中受磁场力控制、电场力加速而达到高能量的装置。
作为为基础科学研究提供条件的工具，粒子加速器在理解各类原子核结构、原子核内部的相互作用、天体物理、宇宙学、生命科学、材料科学、核医学等基础学科有都着重要的意义。
粒子加速器最开始的用途是高能物理研究，在高能物理和粒子物理研究中粒子加速器作为对撞机使用，来研究粒子的微观结构和发现新的物理现象，
比如CERN的LHC（Large Hadron Collider），
日本KEK的SuperKEKB，
美国BNL的RHIC（Relativistic Heavy Ion Collider），
中国的北京正负电子对撞机（Beijing Electron–Positron Collider II，BEPCII）。

%加速器的一些应用
除了高能物理，加速器在其他方面也有着许多应用。
粒子加速器可以用作同步辐射光源，比如美国ALS（Advanced Light Source），上海同步辐射光源，以及北京在建的新光源，同步辐射在物理，材料，化学，生物，医学等方面发挥着越来越重要的作用。
加速器还在医疗方面有很多应用，比如质子治疗是目前最有效的治疗癌症的方法。
除此之外加速器还在能源问题研究起到重要作用，比如加速器驱动次临界洁净核能系统（Accelerator Driven Sub-critical System，ADS），是目前产生核能、增殖核材料和嬗变核废物的解决方案之一。所有的这些需求，都在推动着加速器往更高流强发展。

%我们要研究的是“强流”加速器
粒子加速器的种类繁多，它们的特点各有不同，可以按不同的原则加以分类。按照粒子运动的轨道形状分，可以分为环形加速器和直线加速器。按照加速粒子的种类划分，可以分为电子加速器，离子加速器，其中强流离子加速器为本课题主要的研究范围。
由于加速器相关的大部分实验事例与加速器束流流强正相关，所以强流加速器成为了未来的加速器科学重要的发展方向之一。
强流加速器在在核物理、生命科学、材料科学等基础科学研究，核医学、放射医学等应用研究方面有着越来越重要的作用。
在最近二十年来，得益于高能物理、核物理和包括散裂中子源、加速器驱动的次临界核能系统以及其它应用领域的强烈需求，强流粒子加速器也得到了较大的发展\cite{wei2003synchrotrons,chou2002synchrotron}，随着加速器朝着高流强的方向发展，其面临着新的问题和挑战。

%强流束流动力学：空间电荷，集体效应
强流束流动力学研究的对象加速器中是大量带电粒子在自生库伦场和外界电磁场中的演化问题。其重要的特点是离子束流受空间电荷效应的影响很大，束流的集体不稳定性较为突出，导致束流的整体损失或束流品质变坏。
空间电荷效应是指束团内部粒子之间的直接库仑作用，其作用的来源为束团本身，束团中的粒子带相同的电荷，而相互排斥，粒子会收到束团的斥力，导致带电束团的自然发散和粒子的相位改变。
而集体不稳定性是束团与其运行的环境有关，来源于外部的电磁元件，比如与弯转磁铁，聚焦磁铁，加速腔等的相互作用。
空间电荷效应和束流的集体不稳定性都可能导致束流的整体损失或品质变坏。

%为什么要研究空间电荷，引入束损
空间电荷效应和束流流强，束流能量，以及束团的大小有关。
在现有聚焦强度下，流强越强，空间电荷效应带来的问题越严重。在束流能量低，束流流强大的时候，空间电荷效应非常明显，甚至在内部作用和外部作用中占主导地位。
特别是对束流损失的严格控制和束流功率提升所需要的功率源的问题。更高的束流功率意味着更加严格的束流损失率控制，即使很小的束流损失也将造成机器维护无法进行。
如国际上流行采用平均损失率为1 W/m的手动维护标准，对应于停机4小时后距离束流管0.3 m处的剩余剂量率为100 mrem/hr。这个标准最早是针对1 GeV量级的束流能量的，但对较低的束流能量也基本上适合。譬如，对于能量为1 GeV、平均流强为1 mA的质子束，允许的束流损失率为1 nA/m或10-6/m。这是非常严格的要求，需要从物理设计和技术措施上保证其实现。

%强流束流动力学的难点：空间电荷效应，模拟
因此，强流束流动力学研究的主要问题和难点是如何自洽的表述束流自身产生的非线性空间电荷效应。空间电荷效应导致的束流和粒子的共振和不稳定性，束晕，发射度交换、束流丢失等问题也正成为了强流束流物理中关注的焦点。如何定性，定量理解强流束流动力学中的由于非线性空间电荷效应导致的束流集体不稳定性、束晕粒子形成机制也成为了近年来加速器物理研究中的重要课题。
在束流模拟软件中，随着束流流强的增大，需要模拟的粒子数目上升了若干量级，需要的功能也越来越多。面对新的需求和新的物理问题，我们需要编写一个新的粒子模拟软件，了解并掌握软件背后的计算过程。而且，由于需要模拟的粒子数很大，粒子模拟程序的效率和功能是得到精确物理图像的关键，我们必须针对粒子模拟进行并行优化。

\section{课题研究的现状}
%如何研究空间电荷效应
由于多体非线性耦合系统的复杂性，强流束流物理问题的研究可以从较为粗糙的解析近似和精确的数值模拟两个角度出发。
其中解析方法基本是在哈密顿力学的框架内完成，加上一些必要的近似，建立起一些物理模型，比如束流包络的稳定性问题，单粒子运动以及共振问题等。针对束晕、束流集体效应等问题，目前国际上流行的做法是使用非自洽的模型，比如束核模型，对束晕产生的机制进行分析，给出基本的物理图像。
数值模拟方法主要是使用束流模拟软件在计算机上进行大规模计算，对带电粒子进行跟踪和模拟，其基本模型有传输矩阵映射，PIC（Particle In Cell）数值模拟等。国际上普遍的做法是使用PIC方法进行粒子跟踪，得到粒子演化的图像，分析其背后的物理机制。

解析的方法在某些特定的情况下可以得到准确的结果，但是更多的还是需要近似，与真实的加速器模型相差较远。解析方法可以定性的给出一些束流性质的预测和加速器设计的准则，但是无法给出某个加速器下的具体结论。而数值方法依赖于具体加速器的设计，可以给出相比解析方法更为准确的结果，在加速器建设中起到了必不可少的作用。

目前在国际加速器界存在着一些束流模拟软件
\cite{cern_codeList,takeda1998PARMILA,qiang1999impact,uriot2014tracewin,tanke2002dynac,shishlo2006orbit,aseev2005track}，
如表\ref{tab:space_charge_code}所示。但随着实际加速器的流强上升，我们的需求也越来越多。此外，国外软件大部分都不是开源，不方便我们根据自己的需求进行改进。国际上针对提升程序的效率提升方面也做出了很多探索，比如MPI，OpenMP等等CPU程序并行化，另外，GPU并行计算也是模拟软件的发展方向和研究热点。

\begin{table}
  \centering
  \begin{tabular}{|>{\small}l|c|c|c|c|c|c|c|c|c|}
    \hline
    名称	    &开源  &图形界面 &并行	&数据处理     &匹配	&速度 &精确度	 & 是否收费  \\
    \hline
    Parmila  	&否	   &否	     &否	&是	          &否	&慢	  &低	     & 免费	\\
    Impact  	&否	   &否	     &是	&否	          &否	&较快 &较高	     & 免费	\\
    TraceWin  	&否	   &是	     &是	&是	          &是	&较快 &较高	     & 收费	\\
    Dynac  	    &是	   &否	     &否	&是	          &否	&快   &较低	     & 免费	\\
    Orbit  	    &否	   &否	     &是	&否	          &否	&较快 &较高	     & 免费	\\
    Track  	    &否	   &否	     &否	&否	          &否	&较快 &较高	     & 免费	\\
    \hline
  \end{tabular}
  \caption{束流模拟软件}
  \label{tab:space_charge_code}
\end{table}

国内近年来设计或在建的强流加速器项目有C-ADS，中国散裂中子源（CSNS，China Spallation Neutron Source）等。
依靠于这些项目，国内加速器同行业对强流加速器研究也在进行中。
但是国内对束流模拟软件的探索和开发较少，目前还没有一套比较成熟完备的加速器束流模拟软件。
加速器界同仁大部分依然使用国外的相关软件，并且对软件内部的计算过程并不十分了解。

总之，随着加速器束流流强的增大，需要模拟的粒子数目增加了几个量级，需要的功能也越来越多。
面对新的物理问题，我们需要探索新的算法，优化新的程序结构，编写出一个新的粒子模拟软件，了解并掌握软件背后的计算过程。

\section{本论文主要工作}
本论文的工作主要分三个方面，首先是探索求解空间电荷效应的算法；
其次是多粒子追踪模拟软件的开发，我们将其命名为P-TOPO（Paralleled Trace-Of-Particle-Orbit）；
最后是使用开发的软件P-TOPO进行束流动力学研究。

本文中，第二章将会对强流束流动力学的基本理论进行简要介绍，其中包括束流的横向运动与纵向运动、空间电荷效应的基本理论等，并对国内外的强流加速器进行简要介绍。
第三章为计算机程序的物理模型及程序设计实现，主要介绍在包括束核模型在内的一些物理模型，并对束流模拟程序中常用的PIC算法，和一种新型的保辛算法进行介绍。
第四章介绍模拟程序的设计以及算法的实现，包括程序总体的设计，以及PIC算法在GPU上和CPU集群上的实现，保辛算法在单GPU和GPU集群上的实现，并分别对每一种算法实现进行了正确性校验。
第五章介绍模拟程序的性能和结果，利用模拟程序对空间电荷效应和束流集体效应进行研究，并对C-ADS注入器I进行模拟研究。

\section{论文主要创新之处}
本文对不同的物理模型进行了比较，并开发了束流模拟软件P-TOPO，而目前在国内还没有成熟的加速器束流模拟软件，本课题的有关工作将填补国内的空白。
而且相对于其他束流模拟软件，P-TOPO在很多地方进行了创新。
比如大多数模拟软件使用飞行时间法获得加速腔的相位，而P-TOPO使用类似于实际运行中的扫相方法获得加速腔相位，虽然花费时间要更长，但是结果更加精确；
再比如我们在不同的子程序中使用了不同的并行策略，更加灵活的分配计算负载，提高了并行的效率。

除此之外，本文还在不同的空间电荷算法上进行了探索，并且在GPU上做了实现。
PIC算法和保辛算法在GPU上的实现均有创新，其中保辛算法在GPU上的实现更国际首次。
在PIC算法在GPU集群的实现中，我们比较了不同的并行策略下求解泊松方程的效率，并且实现并测试了新的节点间通讯方法；
而在保辛算法的实现中，我们针对GPU架构进行了海量优化，尤其是针对GPU的内存读写规则，重新组织了程序，使其数据吞吐速度更高。
而且，我们还测试了保辛程序每一部分的加速比和瓶颈，为下一步升级做好了准备。

最后，本文进行了空间电荷的研究，对束晕产生的机制进行了新的探索。在对C-ADS注入器I的模拟中，验证了其设计的合理性。
